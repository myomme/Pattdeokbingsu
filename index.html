<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>íŒ¥ë–¡ë¹™ìˆ˜ & ë¶•ì–´ë¹µ</title>
  <style>
    body { font-family: system-ui, -apple-system, "Pretendard", sans-serif; margin: 16px; background:#f6f7fb; }
    .wrap { max-width: 980px; margin: 0 auto; display: grid; gap: 12px; }
    .card { background: white; border-radius: 14px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow { flex: 1; }
    button { border:0; border-radius: 10px; padding:10px 12px; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .mono { font-variant-numeric: tabular-nums; }
    .badge { padding:4px 8px; border-radius:999px; background:#eef2ff; }
    img.sign { width:100%; height:auto; display:block; border-radius: 12px; }
    .small { color:#667; font-size: 13px; }

    /* ì£¼ë¬¸ UI (ì˜¤ë¥¸ìª½ ì¹´ë“œ ìƒë‹¨ + ë‚´ë¶€ ìŠ¤í¬ë¡¤) */
    .orderBox { border:1px solid #e8eaf2; border-radius: 12px; padding: 10px; margin: 10px 0 14px; background:#fbfcff; }
    .orderTitle { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .orderTitle b { font-size: 14px; }
    .orderList { margin-top:8px; display:grid; gap:6px; max-height: 140px; overflow: auto; padding-right: 4px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#eef2ff; }

    /* ì œì‘ ì„¹ì…˜(ë¹™ìˆ˜/ë¶•ì–´ë¹µ) ë¶„ë¦¬ */
    .makeGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    .makeCard{ border:1px solid #e8eaf2; border-radius: 14px; padding:12px; background:#fbfcff; }
    .makeHead{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:10px; }
    .makeHead b{ font-size:14px; }
    .makeReq{ color:#667; font-size:12px; white-space:nowrap; }
    .makeCard button{ width:100%; }

    /* âœ… ìƒì : 2ê°œì˜ ê·¸ë£¹(ë¹™ìˆ˜/ë¶•ì–´ë¹µ) */
    .shopGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .shopGroup{
      border:1px solid #e8eaf2;
      border-radius:14px;
      padding:12px;
      background:#fbfcff;
    }
    .shopGroupTitle{
      font-weight:800;
      font-size:14px;
      margin-bottom:10px;
      color:#223;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    /* âœ… ìƒì  ì¹´ë“œ(ê°€ë…ì„± + ë²„íŠ¼ ì°¢ì–´ì§ ë°©ì§€) */
    .shop-item{
      display:grid;
      grid-template-columns: 1fr 108px;
      gap:10px;
      padding:12px;
      border:1px solid #e8eaf2;
      border-radius:14px;
      background:#fff;
      align-items:start;
      margin-top:10px;
        transition: transform .15s ease, box-shadow .15s ease;
    }
    .shop-item:hover{
  transform: translateY(-2px);
  box-shadow: 0 8px 22px rgba(0,0,0,.08);
}
    .shopGroup .shop-item:first-of-type{ margin-top:0; }

    .shop-title{
      display:flex;
      gap:8px;
      align-items:baseline;
      margin-bottom:6px;
      min-width:0;
    }
    .shop-title b{ font-size:14px; }
    .shop-title .cur{ color:#667; font-size:12px; white-space:nowrap; }

    .shop-meta{
      display:grid;
      gap:4px;
      font-size:12px;
      color:#556;
    }

    .shop-actions{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .shop-actions button.upBtn{
  background:#f1f3f7;
  color:#223;
}
button:active{
  transform: translateY(1px);
}

.shop-actions button.upBtn.can{
  background:#d9f99d;   /* ì—°í•œ ì—°ë‘ */
  color:#1a2e05;
  font-weight:700;
}

.shop-actions button.upBtn.can:hover{
  background:#bef264;
    }
    .shop-actions button.primary{ background:#111827; color:#fff; }
    .shop-actions button.secondary{ background:#f1f3f7; color:#223; }
    .shop-actions button:disabled{ opacity:.45; }

    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
      .shopGrid{ grid-template-columns: 1fr; }
      .makeGrid{ grid-template-columns: 1fr; }
    }

    .icon{
  width:32px;
  height:32px;
  display:inline-block;
  vertical-align:middle;
  image-rendering: pixelated; /* í”½ì…€ ëŠë‚Œ ì›í•˜ë©´ */
}

.icon.sm{
  width:20px;
  height:20px;
}
.mobileTabs{ display:none; }
@media (max-width: 820px){
  .mobileTabs{ display:flex; gap:8px; }
  .mobileTabs .tabBtn{ flex:1; border-radius:12px; background:#111827; color:#fff; }
  .panel{ display:none; }
  .panel.active{ display:block; }
  .badge{ font-size:12px; padding:4px 6px; }
  .row{ gap:8px; }
}

  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <img class="sign" src="assets/Title/title.png" alt="íŒ¥ë–¡ë¹™ìˆ˜ & ë¶•ì–´ë¹µ ê°„íŒ" />
  </div>

  <div class="card row">
    <div class="grow">
      <div class="row">
        <div class="badge mono">ì†Œì§€ê¸ˆ: <span id="money"></span>ì›</div>
        <div class="badge mono">í¬ì¥ë§ˆì°¨ ê°€ì¹˜(V): <span id="value"></span></div>
        <div class="badge mono">ëˆ„ì  ë§¤ì¶œ: <span id="revenue"></span>ì›</div>
        <div class="badge mono">ëŒ€ê¸° ì£¼ë¬¸: <span id="orderCount"></span>ê±´</div>
        <div class="badge mono">ì†ë‹˜: <span id="custProg"></span></div>
      </div>
      <div class="small" style="margin-top:8px;">
        ëœë¤ íƒ€ì´ë°ìœ¼ë¡œ ì†ë‹˜ì´ ì£¼ë¬¸í•©ë‹ˆë‹¤. ì£¼ë¬¸ ìˆ˜ëŸ‰ë§Œí¼ ë§Œë“¤ì–´ì„œ ë‚©í’ˆí•˜ë©´ ëˆì´ ì¦‰ì‹œ ë“¤ì–´ì˜µë‹ˆë‹¤.
      </div>
    </div>
    <button id="resetBtn" title="ì²˜ìŒë¶€í„°">ë¦¬ì…‹</button>
  </div>
<div class="card mobileTabs">
  <button class="tabBtn" data-tab="play">í”Œë ˆì´</button>
  <button class="tabBtn" data-tab="shop">ìƒì </button>
  <button class="tabBtn" data-tab="rank">ë­í‚¹/ë¡œê·¸</button>
</div>
  <div class="grid">
    <!-- ì™¼ìª½: ìƒì  -->
<div class="card" id="panelShop">
      <h3 style="margin:0 0 8px;">ìƒì </h3>
      <div id="shop"></div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì£¼ë¬¸ + ì¸ë²¤ + ì œì‘ -->
    <div class="card" id="panelPlay">

      <h3 style="margin:0 0 8px;">ì¸ë²¤í† ë¦¬ / ê°€ê²© / ì œì‘</h3>

      <div class="orderBox">
        <div class="orderTitle">
          <b>í˜„ì¬ ì£¼ë¬¸</b>
          <span class="small mono" id="nextCustomerHint"></span>
        </div>
        <div class="orderList" id="orderPanel"></div>
        <div class="small" style="margin-top:8px;">
          â€» í˜„ì¬ ì£¼ë¬¸ì´ ì—†ìœ¼ë©´ ë§Œë“¤ì–´ë„ íŒë§¤ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤(ê·¸ëƒ¥ â€œë§Œë“  ì²™â€ë§Œ í•¨). ì£¼ë¬¸ ë°›ê³  ë§Œë“œëŠ” ê²Œì„ ëŠë‚Œ.
        </div>
      </div>

      <div class="row">
        <div class="badge">
  <img class="icon sm" src="assets/icons/redbean.png">
  íŒ¥ <span class="mono" id="inv_redbean"></span>
</div>
        <div class="badge">
  <img class="icon sm" src="assets/icons/ricecake.png">
  ë–¡ <span class="mono" id="inv_ricecake"></span>
</div>
        <div class="badge">
  <img class="icon sm" src="assets/icons/ice.png">
  ì œë¹™ê¸° <span class="mono" id="inv_ice"></span>
</div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="badge">
  <img class="icon sm" src="assets/icons/batter.png">
  ë°˜ì£½ <span class="mono" id="inv_batter"></span>
</div>
        <div class="badge">
  <img class="icon sm" src="assets/icons/milk.png">
  ìš°ìœ  <span class="mono" id="inv_milk"></span>
</div>
        <div class="badge">
  <img class="icon sm" src="assets/icons/paste.png">
  íŒ¥ì•™ê¸ˆ <span class="mono" id="inv_paste"></span>
</div>
      </div>

      <hr style="border:none;border-top:1px solid #eef0f6;margin:12px 0;" />

      <div class="makeGrid">
        <div class="makeCard">
          <div class="makeHead">
            <b>ğŸ§ íŒ¥ë–¡ë¹™ìˆ˜</b>
            <span class="makeReq">í•„ìš”: íŒ¥+ë–¡+ì œë¹™ê¸°</span>
          </div>
          <div class="mono" style="margin-bottom:6px;">
            ê°€ê²©: <span id="p_bingsu"></span>ì› (ìƒí•œ <span id="cap_bingsu"></span>)
          </div>
          <input id="s_bingsu" type="range" min="500" max="8000" step="100" style="width:100%;" />
          <div style="margin-top:10px;"><button id="makeBingsu">íŒ¥ë–¡ë¹™ìˆ˜ ë§Œë“¤ê¸°</button></div>
          <div class="small" style="margin-top:8px;">â€» ì œë¹™ê¸°ëŠ” ì¥ë¹„ë¼ ì†Œëª¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
        </div>

        <div class="makeCard">
          <div class="makeHead">
            <b>ğŸŸ ë¶•ì–´ë¹µ</b>
            <span class="makeReq">í•„ìš”: ë°˜ì£½+ìš°ìœ +íŒ¥ì•™ê¸ˆ</span>
          </div>
          <div class="mono" style="margin-bottom:6px;">
            ê°€ê²©: <span id="p_fish"></span>ì› (ìƒí•œ <span id="cap_fish"></span>)
          </div>
          <input id="s_fish" type="range" min="200" max="4000" step="50" style="width:100%;" />
          <div style="margin-top:10px;"><button id="makeFish">ë¶•ì–´ë¹µ ë§Œë“¤ê¸°</button></div>
          <div class="small" style="margin-top:8px;">â€» ì¬ë£ŒëŠ” ì œì‘ ì‹œ ì†Œëª¨ë©ë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>
  </div>
<div class="card" id="panelRank">
  <h3 style="margin:0 0 8px;">ë­í‚¹</h3>

  <div class="row" style="margin-bottom:8px;">
    <input id="playerName" placeholder="ë‹‰ë„¤ì„(2~10ì)" maxlength="10"
           style="flex:1; padding:10px 12px; border:1px solid #e8eaf2; border-radius:10px;" />
    <button id="submitRank">ë­í‚¹ ë“±ë¡</button>
  </div>

  <div class="small" style="margin-bottom:6px;">
    ë‚´ ëˆ„ì  ë§¤ì¶œ: <b class="mono" id="myRevenueRank"></b>ì›
  </div>

  <div id="rankList" class="small"></div>
</div>
<div class="card" id="panelLog">
<h3 style="margin:0 0 8px;">ë¡œê·¸ <button id="toggleLog">ì ‘ê¸°</button></h3>
    <div id="log" class="small"></div>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import {
  getFirestore,
  doc, setDoc, getDoc,
  collection, query, orderBy, limit, getDocs,
  serverTimestamp,
  addDoc
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB_i5aelwz0zJ335lkM3gp17LsIuMRFoeU",
    authDomain: "patddeok-3760c.firebaseapp.com",
    projectId: "patddeok-3760c",
    storageBucket: "patddeok-3760c.firebasestorage.app",
    messagingSenderId: "249192870616",
    appId: "1:249192870616:web:27c55c7c983a28ca995dad",
    measurementId: "G-VRE68WVTHE"
  };

  window.firebaseReady = (async () => {
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const cred = await signInAnonymously(auth);

    window._db = db;
    window._uid = cred.user.uid;
    window._fs = { doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs, serverTimestamp, addDoc };



    return true;
  })();
</script>

<script>
  /************************************************************
   * ìƒíƒœ
   ************************************************************/
  const state = {
    money: 10000,
    revenue: 0,
    value: 0,
    inv: { redbean:0, ricecake:0, ice:0, batter:0, milk:0, paste:0 },
    price: { bingsu: 2000, fish: 700 },

    orders: [],
    nextCustomerAt: 0,
    customerTimerId: null,
    upgrades: {
      redbeanTier: 0,
      ricecakeTier: 0,
      iceTier: 0,
      batterTier: 0,
      milkTier: 0,
    },
    run: {
    maxCustomers: 100,
    customersSpawned: 0,
    ended: false,
    endAt: 0
  },
  bestRunScore: 0, // (ì„ íƒ) ë¡œì»¬ ìµœê³  ê¸°ë¡
  };

  const REDBEAN_TIERS = [
    { name: "ì•„ë¼ë¦¬",   buyCost: 300, valueUpBuy: 1 },
    { name: "í°ë‚˜ë˜",   buyCost: 650, valueUpBuy: 2 },
    { name: "ê²€êµ¬ìŠ¬",   buyCost: 1400, valueUpBuy: 3 },
    { name: "ì—°ë‘ì±„",   buyCost: 3200, valueUpBuy: 5 },
    { name: "í™ë‹¤",     buyCost: 7500, valueUpBuy: 8 },
  ];

  const RICECAKE_TIERS = [
    { name: "ì¸ì ˆë¯¸",     buyCost: 400,  valueUpBuy: 1 },
    { name: "ì°¹ìŒ€ë–¡",     buyCost: 900,  valueUpBuy: 2 },
    { name: "ì°¹ìŒ€ê²½ë‹¨",   buyCost: 2000, valueUpBuy: 3 },
    { name: "ìˆ˜ìˆ˜ê²½ë‹¨",   buyCost: 4500, valueUpBuy: 5 },
    { name: "ì½©ê°€ë£¨ê²½ë‹¨", buyCost: 10000,valueUpBuy: 8 },
    { name: "ì‹¤ë°±ê²½ë‹¨",   buyCost: 22000,valueUpBuy: 12 },
  ];

  const ICE_TIERS = [
    { name: "ë ˆíŠ¸ë¡œ ì œë¹™ê¸°", buyCost: 2500,  valueUpBuy: 8 },
    { name: "ì¼ë°˜ ì œë¹™ê¸°",   buyCost: 8000,  valueUpBuy: 12 },
    { name: "ê³ ê¸‰ì œë¹™ê¸°",   buyCost: 24000, valueUpBuy: 18 },
  ];

  const BATTER_TIERS = [
    { name: "ì˜¥ìˆ˜ìˆ˜ê°€ë£¨", buyCost: 250,  valueUpBuy: 1 },
    { name: "ì°¹ìŒ€ê°€ë£¨",   buyCost: 600,  valueUpBuy: 2 },
    { name: "í‘ë¯¸ê°€ë£¨",   buyCost: 1400, valueUpBuy: 3 },
    { name: "ë³´ë¦¬ê°€ë£¨",   buyCost: 3200, valueUpBuy: 5 },
    { name: "ì¹´ì¹´ì˜¤ê°€ë£¨", buyCost: 7500, valueUpBuy: 8 },
    { name: "ë…¹ì°¨ê°€ë£¨",   buyCost: 17000,valueUpBuy: 12 },
  ];

  const MILK_TIERS = [
    { name: "ê°€ê³µìœ ",        buyCost: 200,  valueUpBuy: 1 },
    { name: "2ë“±ê¸‰ ìš°ìœ ",    buyCost: 600,  valueUpBuy: 2 },
    { name: "1Bë“±ê¸‰ ìš°ìœ ",   buyCost: 1800, valueUpBuy: 4 },
    { name: "1Aë“±ê¸‰ ìš°ìœ ",   buyCost: 5200, valueUpBuy: 7 },
  ];

const REDBEAN_UPGRADE_RULE   = { base: 800,  growth: 2.4, needBase: 8,  needStep: 14 };
const RICECAKE_UPGRADE_RULE  = { base: 900,  growth: 2.3, needBase: 8,  needStep: 14 };
const BATTER_UPGRADE_RULE    = { base: 800,  growth: 2.4, needBase: 8,  needStep: 14 };
const MILK_UPGRADE_RULE      = { base: 700,  growth: 2.2, needBase: 7,  needStep: 12 };

// ì œë¹™ê¸°ëŠ” ì›ë˜ë„ ë¬´ê±°ìš°ë‹ˆ ë” ë¬´ê²ê²Œ
const ICE_UPGRADE_RULE       = { base: 2000, growth: 2.6, needBase: 20, needStep: 22 };

  function upgradeCost(rule, nextTier){ return Math.floor(rule.base * (rule.growth ** nextTier)); }
const UPGRADE_V_MULT = 1.6; // 1.2 ~ 2.5 ì‚¬ì´ë¡œ ì¡°ì ˆ

function needValue(rule, nextTier){
  const v = rule.needBase + rule.needStep * nextTier;
  return Math.ceil(v * UPGRADE_V_MULT);
}

  const items = [
    { key:"paste", name:"ğŸ¯ íŒ¥ì•™ê¸ˆ", cost:350, valueUp: 1 },
  ];

  const el = (id)=>document.getElementById(id);
  const fmt = (n)=>Math.floor(n).toLocaleString("ko-KR");
  /************************************************************
 * ë­í‚¹(íŒŒì´ì–´ìŠ¤í† ì–´)
 ************************************************************/
const RANK_COLLECTION = "leaderboard_v1";
const LS_NAME_KEY = "patddeok_name_v1";

function getPlayerName(){
  const input = el("playerName");
  const saved = localStorage.getItem(LS_NAME_KEY) || "";
  const name = (input?.value || saved || "ì†ë‹˜").trim();
  return name || "ì†ë‹˜";
}


let _rankSaveCooldown = 0;

async function saveMyRank(revenueToSave){
  if (!window._db || !window._uid || !window._fs) return;

  const name = getPlayerName();
  const { collection, addDoc, serverTimestamp } = window._fs;

  await addDoc(collection(window._db, RANK_COLLECTION), {
    uid: window._uid,
    name,
    revenue: Number(revenueToSave ?? 0),
    customers: state.run?.customersSpawned ?? 0,     // âœ… ëª‡ ëª…ê¹Œì§€ ë°›ì•˜ëŠ”ì§€
    maxCustomers: state.run?.maxCustomers ?? 100,    // âœ… ê¸°ì¤€(ë³´í†µ 100)
    createdAt: serverTimestamp()
  });
}




async function loadTopRanks(){
  if (!window._db || !window._fs) return;

  const { collection, query, orderBy, limit, getDocs } = window._fs;
  const q = query(
    collection(window._db, RANK_COLLECTION),
    orderBy("revenue", "desc"),
    limit(10)
  );

  const snap = await getDocs(q);
  const rows = [];
  snap.forEach(docu => rows.push(docu.data()));

  renderRanks(rows);
}

async function loadMyRankIntoUI(){
  if (!window._db || !window._uid || !window._fs) return;
  const { doc, getDoc } = window._fs;

  const ref = doc(window._db, RANK_COLLECTION, window._uid);
  const snap = await getDoc(ref);

  const my = snap.exists() ? snap.data() : { revenue: 0, name: "" };
  el("myRevenueRank").textContent = fmt(my.revenue || 0);

  // ë‹‰ë„¤ì„ ì…ë ¥ì¹¸ë„ ë¡œì»¬ ì €ì¥ê°’ìœ¼ë¡œ ì±„ì›Œì£¼ê¸°(í¸ì˜)
  const savedName = localStorage.getItem(LS_NAME_KEY) || my.name || "";
  if (el("playerName") && !el("playerName").value) el("playerName").value = savedName;
}


function renderRanks(rows){
  const box = el("rankList");
  if (!box) return;

  if (!rows.length){
    box.textContent = "ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  box.innerHTML = rows.map((r, i) => {
    const n = (r?.name ?? "ì†ë‹˜");
    const rev = fmt(r?.revenue ?? 0);
    return `<div class="mono">${i+1}. ${escapeHtml(n)} â€” ${rev}ì›</div>`;
  }).join("");
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

  const now = ()=>Date.now();

  function log(msg){
    const div = document.createElement("div");
    div.textContent = msg;
    el("log").prepend(div);
  }

  /************************************************************
   * ê°€ê²© ìƒí•œ
   ************************************************************/
  function caps(){
    const capB = 3000 + state.value * 120;
    const capF = 1000 + state.value * 60;
    return { capB, capF };
  }

  /************************************************************
   * ì£¼ë¬¸ UI
   ************************************************************/
  function renderOrders(){
    const panel = el("orderPanel");
    panel.innerHTML = "";

    el("orderCount").textContent = state.orders.length;

    const cur = state.orders[0];
    if (!cur){
      const empty = document.createElement("div");
      empty.className = "small";
      empty.textContent = "í˜„ì¬ ì£¼ë¬¸ ì—†ìŒ (ì†ë‹˜ì´ ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì„¸ìš”)";
      panel.appendChild(empty);
      return;
    }

    const line1 = document.createElement("div");
    line1.className = "pill mono";
    line1.textContent = `ğŸ§‘ ì†ë‹˜ ì£¼ë¬¸ #1  |  ë¹™ìˆ˜ ${cur.bingsu}ê°œ, ë¶•ì–´ë¹µ ${cur.fish}ê°œ`;
    panel.appendChild(line1);

    if (state.orders.length > 1){
      const more = document.createElement("div");
      more.className = "small mono";
      more.textContent = `ë’¤ì— ${state.orders.length - 1}ê±´ ë” ëŒ€ê¸° ì¤‘`;
      panel.appendChild(more);
    }
  }

  function updateNextCustomerHint(){
    const t = state.nextCustomerAt;
    if (!t){ el("nextCustomerHint").textContent = ""; return; }
    const sec = Math.max(0, Math.ceil((t - now())/1000));
    el("nextCustomerHint").textContent = `ë‹¤ìŒ ì†ë‹˜ ì˜ˆìƒ: ${sec}s`;
  }

  /************************************************************
   * UI ë™ê¸°í™”
   ************************************************************/
  function syncUI(){
    el("money").textContent = fmt(state.money);
    el("revenue").textContent = fmt(state.revenue);
    el("value").textContent = state.value;
    el("custProg").textContent = `${state.run.customersSpawned}/${state.run.maxCustomers}`;

    for (const k of Object.keys(state.inv)) el("inv_"+k).textContent = state.inv[k];

    const { capB, capF } = caps();
    el("cap_bingsu").textContent = fmt(capB);
    el("cap_fish").textContent = fmt(capF);

    state.price.bingsu = Math.min(state.price.bingsu, capB);
    state.price.fish = Math.min(state.price.fish, capF);

    el("s_bingsu").max = capB;
    el("s_fish").max = capF;

    el("s_bingsu").value = state.price.bingsu;
    el("s_fish").value = state.price.fish;

    el("p_bingsu").textContent = fmt(state.price.bingsu);
    el("p_fish").textContent = fmt(state.price.fish);

    el("makeBingsu").disabled = !(state.inv.redbean>=1 && state.inv.ricecake>=1 && state.inv.ice>=1);
    el("makeFish").disabled   = !(state.inv.batter>=1 && state.inv.milk>=1 && state.inv.paste>=1);

    renderOrders();
  }

  /************************************************************
   * êµ¬ë§¤
   ************************************************************/
  function buy(key){
    if (key === "redbean") {
      const t = REDBEAN_TIERS[state.upgrades.redbeanTier];
      if (state.money < t.buyCost) return log("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
      state.money -= t.buyCost;
      state.value += t.valueUpBuy;
      state.inv.redbean += 1;
      log(`ğŸ«˜ íŒ¥(${t.name}) êµ¬ë§¤ (-${fmt(t.buyCost)}ì›) / ê°€ì¹˜ +${t.valueUpBuy}`);
      renderShop(); syncUI(); return;
    }

    if (key === "ricecake") {
      const t = RICECAKE_TIERS[state.upgrades.ricecakeTier];
      if (state.money < t.buyCost) return log("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
      state.money -= t.buyCost;
      state.value += t.valueUpBuy;
      state.inv.ricecake += 1;
      log(`ğŸ¡ ë–¡(${t.name}) êµ¬ë§¤ (-${fmt(t.buyCost)}ì›) / ê°€ì¹˜ +${t.valueUpBuy}`);
      renderShop(); syncUI(); return;
    }

    if (key === "ice") {
      if (state.inv.ice >= 1) return log("ì œë¹™ê¸°ëŠ” ì´ë¯¸ ë³´ìœ  ì¤‘ì…ë‹ˆë‹¤.");
      const t = ICE_TIERS[state.upgrades.iceTier];
      if (state.money < t.buyCost) return log("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
      state.money -= t.buyCost;
      state.value += t.valueUpBuy;
      state.inv.ice += 1;
      log(`ğŸ§Š ì œë¹™ê¸°(${t.name}) êµ¬ë§¤ (-${fmt(t.buyCost)}ì›) / ê°€ì¹˜ +${t.valueUpBuy}`);
      renderShop(); syncUI(); return;
    }

    if (key === "batter") {
      const t = BATTER_TIERS[state.upgrades.batterTier];
      if (state.money < t.buyCost) return log("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
      state.money -= t.buyCost;
      state.value += t.valueUpBuy;
      state.inv.batter += 1;
      log(`ğŸ¥£ ë°˜ì£½(${t.name}) êµ¬ë§¤ (-${fmt(t.buyCost)}ì›) / ê°€ì¹˜ +${t.valueUpBuy}`);
      renderShop(); syncUI(); return;
    }

    if (key === "milk") {
      const t = MILK_TIERS[state.upgrades.milkTier];
      if (state.money < t.buyCost) return log("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
      state.money -= t.buyCost;
      state.value += t.valueUpBuy;
      state.inv.milk += 1;
      log(`ğŸ¥› ìš°ìœ (${t.name}) êµ¬ë§¤ (-${fmt(t.buyCost)}ì›) / ê°€ì¹˜ +${t.valueUpBuy}`);
      renderShop(); syncUI(); return;
    }

    // íŒ¥ì•™ê¸ˆ(ì¼ë°˜ êµ¬ë§¤)
    const it = items.find(x=>x.key===key);
    if (!it) return;
    if (state.money < it.cost) return log("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    state.money -= it.cost;
    state.value += it.valueUp;
    state.inv[key] += 1;
    log(`${it.name} êµ¬ë§¤ (-${fmt(it.cost)}ì›) / ê°€ì¹˜ +${it.valueUp}`);
    renderShop(); syncUI();
  }

  /************************************************************
   * ì—…ê·¸ë ˆì´ë“œ
   ************************************************************/
  function upgradeRedbean(){
    const cur = state.upgrades.redbeanTier;
    if (cur >= REDBEAN_TIERS.length - 1) return log("íŒ¥ì€ ì´ë¯¸ ìµœê³  ë“±ê¸‰ì…ë‹ˆë‹¤.");
    const next = cur + 1;
    const cost = upgradeCost(REDBEAN_UPGRADE_RULE, next);
    const needV = needValue(REDBEAN_UPGRADE_RULE, next);
    if (state.value < needV) return log(`ê°€ì¹˜(V)ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í•„ìš” Vâ‰¥${needV}`);
    if (state.money < cost) return log(`ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© ë¶€ì¡± (-${fmt(cost)}ì› í•„ìš”)`);
    state.money -= cost;
    state.upgrades.redbeanTier = next;
    log(`â¬†ï¸ íŒ¥ ì—…ê·¸ë ˆì´ë“œ: ${REDBEAN_TIERS[cur].name} â†’ ${REDBEAN_TIERS[next].name} (-${fmt(cost)}ì›)`);
    renderShop(); syncUI();
  }

  function upgradeRicecake(){
    const cur = state.upgrades.ricecakeTier;
    if (cur >= RICECAKE_TIERS.length - 1) return log("ë–¡ì€ ì´ë¯¸ ìµœê³  ë“±ê¸‰ì…ë‹ˆë‹¤.");
    const next = cur + 1;
    const cost = upgradeCost(RICECAKE_UPGRADE_RULE, next);
    const needV = needValue(RICECAKE_UPGRADE_RULE, next);
    if (state.value < needV) return log(`ê°€ì¹˜(V)ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í•„ìš” Vâ‰¥${needV}`);
    if (state.money < cost) return log(`ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© ë¶€ì¡± (-${fmt(cost)}ì› í•„ìš”)`);
    state.money -= cost;
    state.upgrades.ricecakeTier = next;
    log(`â¬†ï¸ ë–¡ ì—…ê·¸ë ˆì´ë“œ: ${RICECAKE_TIERS[cur].name} â†’ ${RICECAKE_TIERS[next].name} (-${fmt(cost)}ì›)`);
    renderShop(); syncUI();
  }

  function upgradeIce(){
    const cur = state.upgrades.iceTier;
    if (cur >= ICE_TIERS.length - 1) return log("ì œë¹™ê¸°ëŠ” ì´ë¯¸ ìµœê³  ë“±ê¸‰ì…ë‹ˆë‹¤.");
    const next = cur + 1;
    const cost = upgradeCost(ICE_UPGRADE_RULE, next);
    const needV = needValue(ICE_UPGRADE_RULE, next);
    if (state.value < needV) return log(`ê°€ì¹˜(V)ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í•„ìš” Vâ‰¥${needV}`);
    if (state.money < cost) return log(`ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© ë¶€ì¡± (-${fmt(cost)}ì› í•„ìš”)`);
    state.money -= cost;
    state.upgrades.iceTier = next;
    log(`â¬†ï¸ ì œë¹™ê¸° ì—…ê·¸ë ˆì´ë“œ: ${ICE_TIERS[cur].name} â†’ ${ICE_TIERS[next].name} (-${fmt(cost)}ì›)`);
    renderShop(); syncUI();
  }

  function upgradeBatter(){
    const cur = state.upgrades.batterTier;
    if (cur >= BATTER_TIERS.length - 1) return log("ë°˜ì£½ì€ ì´ë¯¸ ìµœê³  ë“±ê¸‰ì…ë‹ˆë‹¤.");
    const next = cur + 1;
    const cost = upgradeCost(BATTER_UPGRADE_RULE, next);
    const needV = needValue(BATTER_UPGRADE_RULE, next);
    if (state.value < needV) return log(`ê°€ì¹˜(V)ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í•„ìš” Vâ‰¥${needV}`);
    if (state.money < cost) return log(`ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© ë¶€ì¡± (-${fmt(cost)}ì› í•„ìš”)`);
    state.money -= cost;
    state.upgrades.batterTier = next;
    log(`â¬†ï¸ ë°˜ì£½ ì—…ê·¸ë ˆì´ë“œ: ${BATTER_TIERS[cur].name} â†’ ${BATTER_TIERS[next].name} (-${fmt(cost)}ì›)`);
    renderShop(); syncUI();
  }

  function upgradeMilk(){
    const cur = state.upgrades.milkTier;
    if (cur >= MILK_TIERS.length - 1) return log("ìš°ìœ ëŠ” ì´ë¯¸ ìµœê³  ë“±ê¸‰ì…ë‹ˆë‹¤.");
    const next = cur + 1;
    const cost = upgradeCost(MILK_UPGRADE_RULE, next);
    const needV = needValue(MILK_UPGRADE_RULE, next);
    if (state.value < needV) return log(`ê°€ì¹˜(V)ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í•„ìš” Vâ‰¥${needV}`);
    if (state.money < cost) return log(`ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© ë¶€ì¡± (-${fmt(cost)}ì› í•„ìš”)`);
    state.money -= cost;
    state.upgrades.milkTier = next;
    log(`â¬†ï¸ ìš°ìœ  ì—…ê·¸ë ˆì´ë“œ: ${MILK_TIERS[cur].name} â†’ ${MILK_TIERS[next].name} (-${fmt(cost)}ì›)`);
    renderShop(); syncUI();
  }

  /************************************************************
   * ì œì‘/ë‚©í’ˆ
   ************************************************************/
  function sellAttempt(productName, price, baseWtp){
    const wtp = baseWtp + state.value*40 + randInt(-200, 200);
    if (price <= wtp){
      state.money += price;
      state.revenue += price;
      log(`âœ… ${productName} ë‚©í’ˆ +${fmt(price)}ì› (ì†ë‹˜ WTP=${fmt(wtp)})`);
    } else {
      log(`âŒ ${productName} ê±°ì ˆ (ê°€ê²© ${fmt(price)} > WTP ${fmt(wtp)})`);
    }

  }

  function fulfillOne(product){
    const cur = state.orders[0];
    if (product === "bingsu") {
      if (cur.bingsu <= 0) return log("í˜„ì¬ ì£¼ë¬¸ì—ëŠ” ë¹™ìˆ˜ê°€ ë” ì´ìƒ í•„ìš” ì—†ìŠµë‹ˆë‹¤.");
      cur.bingsu -= 1;
      sellAttempt("ë¹™ìˆ˜", state.price.bingsu, 2000);
    } else {
      if (cur.fish <= 0) return log("í˜„ì¬ ì£¼ë¬¸ì—ëŠ” ë¶•ì–´ë¹µì´ ë” ì´ìƒ í•„ìš” ì—†ìŠµë‹ˆë‹¤.");
      cur.fish -= 1;
      sellAttempt("ë¶•ì–´ë¹µ", state.price.fish, 700);
    }

    if (cur.bingsu === 0 && cur.fish === 0){
      state.orders.shift();
      log("âœ… ì£¼ë¬¸ ì™„ë£Œ! ë‹¤ìŒ ì†ë‹˜ ëŒ€ê¸°.");
    }
    tryEndRun();
    syncUI();
  }
  function tryEndRun(){
  if (state.run.ended) return;

  const allCustomersArrived = state.run.customersSpawned >= state.run.maxCustomers;
  const noPendingOrders = state.orders.length === 0;

  if (allCustomersArrived && noPendingOrders){
    state.run.ended = true;
    state.run.endAt = now();
    clearTimeout(state.customerTimerId);
    state.customerTimerId = null;
    state.nextCustomerAt = 0;

    log(`ğŸ ê²Œì„ ì¢…ë£Œ! ìµœì¢… ë§¤ì¶œ: ${fmt(state.revenue)}ì› (ì†ë‹˜ ${state.run.maxCustomers}ëª…)`);
    // ì—¬ê¸°ì„œ ë­í‚¹ ë“±ë¡ì„ "ê°€ëŠ¥" ìƒíƒœë¡œ ë§Œë“¤ê±°ë‚˜, ìë™ ì €ì¥(ì›í•˜ë©´)
  }
}

  function makeBingsu(){
    if (state.orders.length === 0) return log("ëŒ€ê¸° ì¤‘ì¸ ì†ë‹˜ì´ ì—†ìŠµë‹ˆë‹¤. ì†ë‹˜ì´ ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì„¸ìš”.");
    if (!(state.inv.redbean>=1 && state.inv.ricecake>=1 && state.inv.ice>=1)) return;
    state.inv.redbean -= 1;
    state.inv.ricecake -= 1;
    fulfillOne("bingsu");
  }

  function makeFish(){
    if (state.orders.length === 0) return log("ëŒ€ê¸° ì¤‘ì¸ ì†ë‹˜ì´ ì—†ìŠµë‹ˆë‹¤. ì†ë‹˜ì´ ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì„¸ìš”.");
    if (!(state.inv.batter>=1 && state.inv.milk>=1 && state.inv.paste>=1)) return;
    state.inv.batter -= 1;
    state.inv.milk -= 1;
    state.inv.paste -= 1;
    fulfillOne("fish");
  }

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

  /************************************************************
   * ì†ë‹˜ ìƒì„±
   ************************************************************/
   function scheduleNextCustomer(){
  if (state.run.ended) return;
  if (state.run.customersSpawned >= state.run.maxCustomers) return;

  const ms = randInt(7000, 30000);
  state.nextCustomerAt = now() + ms;
  updateNextCustomerHint();

  clearTimeout(state.customerTimerId);
  state.customerTimerId = setTimeout(()=>{
    spawnCustomerOrder();
    scheduleNextCustomer();
  }, ms);
}

  function spawnCustomerOrder(){
  if (state.run.ended) return;

  // 100ëª… ì œí•œ
  if (state.run.customersSpawned >= state.run.maxCustomers) {
    // ë” ì´ìƒ ì†ë‹˜ ì•ˆ ë°›ìŒ(ìŠ¤ì¼€ì¤„ë„ ì¤‘ë‹¨ì€ scheduleNextCustomerì—ì„œ ì²˜ë¦¬)
    return;
  }

  state.run.customersSpawned += 1;

  const b = randInt(0, 3);
  const f = randInt(1, 6);
  state.orders.push({ id: crypto.randomUUID(), bingsu: b, fish: f, createdAt: now() });

  log(`ğŸ§‘ ì†ë‹˜ #${state.run.customersSpawned} ë“±ì¥! "ë¹™ìˆ˜ ${b}ê°œ, ë¶•ì–´ë¹µ ${f}ê°œ ì£¼ì„¸ìš”!"`);
  syncUI();

  // 100ë²ˆì§¸ ì†ë‹˜ ìƒì„± ì§í›„: ë‹¤ìŒ ì†ë‹˜ ìŠ¤ì¼€ì¤„ ëŠê¸°
  if (state.run.customersSpawned >= state.run.maxCustomers) {
    state.nextCustomerAt = 0;
    clearTimeout(state.customerTimerId);
    state.customerTimerId = null;
    log("â›” ì˜¤ëŠ˜ ì¥ì‚¬ ë§ˆê°! (ë§ˆì§€ë§‰ ì£¼ë¬¸ë“¤ ì²˜ë¦¬ í›„ ì¢…ë£Œë©ë‹ˆë‹¤)");
  }
}


  setInterval(updateNextCustomerHint, 1000);

  /************************************************************
   * âœ… ìƒì  ë Œë”(ì •ë¦¬ë³¸)
   ************************************************************/
  function makeTierCard({ iconTitle, tierArr, tierKey, buyKey, upgradeFn, rule, extraBuyLine="" }){
  const tier = state.upgrades[tierKey];
  const t = tierArr[tier];
  const canUpgrade = tier < tierArr.length - 1;
  const nextTier = Math.min(tier + 1, tierArr.length - 1);

  const needV = canUpgrade ? needValue(rule, nextTier) : null;
  const upCost = canUpgrade ? upgradeCost(rule, nextTier) : null;

  const div = document.createElement("div");
  div.className = "shop-item";
  div.innerHTML = `
    <div>
      <div class="shop-title">
        <b>${iconTitle}</b>
        <span class="cur">(í˜„ì¬: ${t.name})</span>
      </div>
      <div class="shop-meta">
        <div class="mono">êµ¬ë§¤: ${fmt(t.buyCost)}ì› Â· V+${t.valueUpBuy}${extraBuyLine}</div>
        <div class="mono">
          ${canUpgrade
            ? `ì—…ê¸€: ${tierArr[tier].name}â†’${tierArr[nextTier].name} Â· ${fmt(upCost)}ì› Â· Vâ‰¥${needV}`
            : `ì—…ê¸€: ìµœê³  ë“±ê¸‰`
          }
        </div>
      </div>
    </div>
    <div class="shop-actions">
      <button class="buyBtn primary">êµ¬ë§¤</button>
      <button class="upBtn${canUpgrade ? " can" : ""}" ${canUpgrade ? "" : "disabled"}>ì—…ê¸€</button>
    </div>
  `;

  div.querySelector(".buyBtn").onclick = ()=>buy(buyKey);

  const upBtn = div.querySelector(".upBtn");
  if (canUpgrade) {
    upBtn.onclick = upgradeFn;

    // ëˆ/V ì¡°ê±´ ë¶€ì¡±í•˜ë©´ ë¹„í™œì„± + ìƒ‰ ì œê±°
    if (state.value < needV || state.money < upCost) {
      upBtn.disabled = true;
      upBtn.classList.remove("can");
    }
  }

  return div;
}


  function makeSimpleCard(){
  const it = items[0]; // paste
  const div = document.createElement("div");
  div.className = "shop-item";
  div.innerHTML = `
    <div>
      <div class="shop-title">
        <b>${it.name}</b>
        <span class="cur">(ì¼ë°˜)</span>
      </div>
      <div class="shop-meta">
        <div class="mono">êµ¬ë§¤: ${fmt(it.cost)}ì› Â· V+${it.valueUp}</div>
        <div class="mono">ì—…ê¸€: ì—†ìŒ</div>
      </div>
    </div>
    <div class="shop-actions">
      <button class="buyBtn primary">êµ¬ë§¤</button>
      <button class="upBtn" disabled>ì—…ê¸€</button>
    </div>
  `;
  div.querySelector(".buyBtn").onclick = ()=>buy("paste");
  return div;
}


  function renderShop(){
    const root = el("shop");
    root.innerHTML = "";

    const grid = document.createElement("div");
    grid.className = "shopGrid";

    const g1 = document.createElement("div");
    g1.className = "shopGroup";
    g1.innerHTML = `<div class="shopGroupTitle">ë¹™ìˆ˜ ë¼ì¸ <span class="small">ğŸ«˜+ğŸ¡+ğŸ§Š</span></div>`;

    const g2 = document.createElement("div");
    g2.className = "shopGroup";
    g2.innerHTML = `<div class="shopGroupTitle">ë¶•ì–´ë¹µ ë¼ì¸ <span class="small">ğŸ¥£+ğŸ¥›+ğŸ¯</span></div>`;

    // ë¹™ìˆ˜ ë¼ì¸: íŒ¥/ë–¡/ì œë¹™ê¸°
    g1.appendChild(makeTierCard({
      iconTitle: `<img class="icon" src="assets/icons/redbean.png"> íŒ¥`,
      tierArr: REDBEAN_TIERS,
      tierKey: "redbeanTier",
      buyKey: "redbean",
      upgradeFn: upgradeRedbean,
      rule: REDBEAN_UPGRADE_RULE
    }));

    g1.appendChild(makeTierCard({
      iconTitle: `<img class="icon" src="assets/icons/ricecake.png"> ë–¡`,
      tierArr: RICECAKE_TIERS,
      tierKey: "ricecakeTier",
      buyKey: "ricecake",
      upgradeFn: upgradeRicecake,
      rule: RICECAKE_UPGRADE_RULE
    }));

    g1.appendChild(makeTierCard({
      iconTitle: `<img class="icon" src="assets/icons/ice.png"> ì œë¹™ê¸°`,
      tierArr: ICE_TIERS,
      tierKey: "iceTier",
      buyKey: "ice",
      upgradeFn: upgradeIce,
      rule: ICE_UPGRADE_RULE,
      extraBuyLine: state.inv.ice>=1 ? " (ë³´ìœ ì¤‘)" : ""
    }));

    // ë¶•ì–´ë¹µ ë¼ì¸: ë°˜ì£½/ìš°ìœ /íŒ¥ì•™ê¸ˆ
    g2.appendChild(makeTierCard({
      iconTitle: `<img class="icon" src="assets/icons/batter.png"> ë°˜ì£½`,
      tierArr: BATTER_TIERS,
      tierKey: "batterTier",
      buyKey: "batter",
      upgradeFn: upgradeBatter,
      rule: BATTER_UPGRADE_RULE
    }));

    g2.appendChild(makeTierCard({
      iconTitle: `<img class="icon" src="assets/icons/milk.png"> ìš°ìœ `,
      tierArr: MILK_TIERS,
      tierKey: "milkTier",
      buyKey: "milk",
      upgradeFn: upgradeMilk,
      rule: MILK_UPGRADE_RULE
    }));

    g2.appendChild(makeSimpleCard());

    grid.appendChild(g1);
    grid.appendChild(g2);
    root.appendChild(grid);
  }


function setMobileTab(tab){
  const map = {
    play: ["panelPlay"],
    shop: ["panelShop"],
    rank: ["panelRank","panelLog"],
  };
  ["panelPlay","panelShop","panelRank","panelLog"].forEach(id=>{
    const node = document.getElementById(id);
    if(node) node.classList.remove("active","panel");
    if(node) node.classList.add("panel");
  });
  (map[tab]||["panelPlay"]).forEach(id=>{
    const node = document.getElementById(id);
    if(node) node.classList.add("active");
  });
  const firstId = (map[tab]||["panelPlay"])[0];
document.getElementById(firstId)?.scrollIntoView({ behavior:"smooth", block:"start" });
}
document.querySelectorAll(".tabBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>setMobileTab(btn.dataset.tab));
});
if (window.matchMedia("(max-width: 820px)").matches) setMobileTab("play");
  /************************************************************
   * ë¦¬ì…‹
   ************************************************************/
  function reset(){
    state.upgrades.redbeanTier = 0;
    state.upgrades.ricecakeTier = 0;
    state.upgrades.iceTier = 0;
    state.upgrades.batterTier = 0;
    state.upgrades.milkTier = 0;
    state.run.maxCustomers = 100;
state.run.customersSpawned = 0;
state.run.ended = false;
state.run.endAt = 0;
    state.money = 10000;
    state.revenue = 0;
    state.value = 0;
    for (const k in state.inv) state.inv[k]=0;
    state.price.bingsu = 2000;
    state.price.fish = 700;

    state.orders = [];
    state.nextCustomerAt = 0;
    clearTimeout(state.customerTimerId);
    state.customerTimerId = null;

    el("log").innerHTML = "";
    log("ë¦¬ì…‹ ì™„ë£Œ. 10,000ì› ì§€ê¸‰.");

    renderShop();
    syncUI();
    scheduleNextCustomer();
    loadTopRanks();
      loadMyRankIntoUI(); // ì•„ë˜ 2ë²ˆì—ì„œ ì¶”ê°€í•  í•¨ìˆ˜
  }

  /************************************************************
   * ì´ë²¤íŠ¸ ë°”ì¸ë”©
   ************************************************************/
  el("s_bingsu").addEventListener("input", (e)=>{ state.price.bingsu = Number(e.target.value); syncUI(); });
  el("s_fish").addEventListener("input", (e)=>{ state.price.fish = Number(e.target.value); syncUI(); });
  el("makeBingsu").onclick = makeBingsu;
  el("makeFish").onclick = makeFish;
  el("resetBtn").onclick = reset;
  // âœ… (B) ë­í‚¹ ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ì—¬ê¸°ì— ì¶”ê°€)
  el("submitRank").onclick = async ()=>{
  try{
    const name = el("playerName").value.trim();
    if (name.length < 2 || name.length > 10) return log("ë‹‰ë„¤ì„ì€ 2~10ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");
    localStorage.setItem(LS_NAME_KEY, name);

    const snapRevenue = state.revenue;
    log(`â³ ë­í‚¹ ì €ì¥ ì‹œë„... (ë“±ë¡ ë§¤ì¶œ: ${fmt(snapRevenue)}ì›)`);
    await saveMyRank(snapRevenue);
    await loadTopRanks();
    log(`âœ… ë­í‚¹ ë“±ë¡ ì™„ë£Œ: ${name} / ${fmt(snapRevenue)}ì›`);
  }catch(e){
    console.error(e);
    log(`âŒ ë­í‚¹ ë“±ë¡ ì‹¤íŒ¨: ${e?.message || e}`);
  }
};
let logOpen = false;
document.getElementById("toggleLog").onclick = ()=>{
  logOpen = !logOpen;
  document.getElementById("log").style.display = logOpen ? "block" : "none";
};
if (window.matchMedia("(max-width: 820px)").matches) {
  document.getElementById("log").style.display = "none";
}


  /************************************************************
   * ì‹œì‘
   ************************************************************/
async function waitFirebaseReady(){
  while(!window.firebaseReady) {
    await new Promise(r => setTimeout(r, 30));
  }
  await window.firebaseReady;
}

(async ()=>{
  await waitFirebaseReady();   // âœ… ì—¬ê¸°ë¡œ ë³€ê²½
  renderShop();
  reset();
})();
</script>
</body>
</html>
